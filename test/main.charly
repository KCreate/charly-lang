let UnitTest = require("unit-test");

UnitTest("Charly").begin(func(describe) {

  describe("Including external files", func(it) {

    it("includes a file", func(assert) {
      assert(include("external.charly").num, 25);
      assert(include("external.charly").num, 25);

      assert(include("external.charly").increment(0), 1);
      assert(include("external.charly").increment(0), 1);
    });

    it("requires a file", func(assert) {
      assert(require("external.charly").num, 25);
      assert(require("external.charly").num, 25);

      let external = require("external.charly");
      external.num = 50;

      assert(require("external.charly").num, 50);

      # Reset for further tests
      external.num = 25;
    });

    it("includes a file that's already required", func(assert) {
      let external = require("external.charly");
      external.num = 50;

      assert(require("external.charly") == external, true);
      assert(require("external.charly").num, 50);
      assert(include("external.charly").num, 25);

      # Reset for further tests
      external.num = 25;
    });

    it("includes core modules", func(assert) {
      let io = include("io");
      assert(!!io.stdout.print, true);
      assert(!!io.stderr.write, true);
      assert(!!io.stdin.getc, true);

      let array = include("array");
      assert(!!array.each, true);
    });

  });

  describe("Variables", func(it) {

    it("assigns a value to a variable", func(assert) {
      let my_string = "Hello World";
      let my_number = 25;
      let my_bool = false;
      let my_array = [1, "Whatsup", false];
      let my_null = null;

      assert(my_string, "Hello World");
      assert(my_number, 25);
      assert(my_bool, false);
      assert(my_array[1], "Whatsup");
      assert(my_null, null);
    });

    it("resolves variables in calculations", func(assert) {
      let first_number = 25;
      let second_number = 5;

      assert(first_number + second_number, 30);
    });

    it("primitives are always passed by value", func(assert) {
      let a = 5;
      let b = a;
      a = 30;

      assert(a, 30);
      assert(b, 5);
    });

  });

  describe("Arithmetic operations", func(it) {

    it("adds numbers", func(assert) {
      assert(2 + 2, 4);
      assert(10 + -50, -40);
      assert(2.5 + 9.7, 12.2);
      assert(-20.5 + 20.5, 0);
      assert(999.999 + 999.999, 1999.998);
    });

    it("subtracts numbers", func(assert) {
      assert(20 - 5, 15);
      assert(3 - 3, 0);
      assert(-5 - 9, -14);
      assert(-0 - -0, 0);
      assert(-20 - -90, 70);
    });

    it("multiplies numbers", func(assert) {
      assert(2 * 0, 0);
      assert(2 * 5, 10);
      assert(3 * 25, 75);
      assert(9 * -50, -450);
      assert(0.5 * 5, 2.5);
    });

    it("divides numbers", func(assert) {
      assert(5 / 0, null);
      assert(5 / -2, -2.5);
      assert(10 / 4, 2.5);
      assert(100 / 8, 12.5);
      assert(1 / 2, 0.5);
    });

    it("modulus operator", func(assert) {
      assert(6 % 3, 0);
      assert(0 % 0, null);
      assert(177 % 34, 7);
      assert(700 % 200, 100);
      assert(20 % 3, 2);
    });

    it("pow operator", func(assert) {
      assert(2**8, 256);
      assert(50**3, 125000);
      assert(2**4, 16);
      assert(50**1, 50);
      assert(50**0, 1);
    });

  });

  describe("Comparisons", func(it) {

    it("compares numerics", func(assert) {
      assert(2 == 2, true);
      assert(20 == 20, true);
      assert(-200 == -200, true);
      assert(2.2323 == 2.2323, true);
      assert(9.666 == 9.666, true);
      assert(-0 == -0, true);
      assert(-0 == 0, true);
    });

    it("compares booleans", func(assert) {
      assert(false == false, true);
      assert(false == true, false);
      assert(true == false, false);
      assert(true == true, true);

      assert(0 == false, true);
      assert(1 == true, true);
      assert(-1 == true, true);
      assert("" == true, true);
      assert("test" == true, true);
      assert([] == true, true);
      assert([1, 2] == true, true);
      assert(null == false, true);
      assert({ let name = "leonard"; } == true, true);
      assert(func(){} == true, true);
      assert(class Test {} == true, true);
    });

    it("compares strings", func(assert) {
      assert("test" == "test", true);
      assert("" == "", true);
      assert("leeöäüp" == "leeöäüp", true);
      assert("2002" == "2002", true);
      assert("asdlkasd" == "asdlkasd", true);
    });

    it("compares objects", func(assert) {
      assert({} == {}, false);
      assert({ let a = 1; } == {}, false);
      assert({} == { let a = 1; }, false);
      assert({ let a = 1; } == { let a = 1; }, false);

      let me = {
        let name = "Leonard";
      };

      assert(me == me, true);
      assert(me.name == me.name, true);
    });

    it("compares functions", func(assert) {
      assert(func(){} == func(){}, false);
      assert(func(arg){} == func(arg){}, false);
      assert(func(arg){ arg + 1; } == func(arg){ arg + 1; }, false);
      assert(func(){ 2; } == func(){ 2; }, false);
    });

    it("does misc. comparisons", func(assert) {
      assert(null == null, true);
      assert(null ! null, false);
    });

    it("compares non equals", func(assert) {
      assert(2 == 4, false);
      assert(10 == 20, false);
      assert(2.5 == 2.499999, false);
      assert(-20 == 20, false);
      assert(2 == 20, false);

      assert(2 ! 4, true);
      assert(10 ! 20, true);
      assert(2.5 ! 2.499999, true);
      assert(-20 ! 20, true);
      assert(2 ! 20, true);
    });

    it("compares using >", func(assert) {
      assert(2 > 5, false);
      assert(10 > 10, false);
      assert(20 > -20, true);
      assert(4 > 3, true);
      assert(0 > -1, true);

      assert("test" > "test", false);
      assert("whatsup" > "whatsu", true);
      assert("test" > 2, false);
      assert("test" > "tes", true);
      assert(2 > "asdadasd", false);
      assert("" > "", false);
      assert(false > true, false);
      assert(25000 > false, false);
      assert(000.222 > "000.222", false);
      assert(null > "lol", false);
    });

    it("compares using <", func(assert) {
      assert(2 < 5, true);
      assert(10 < 10, false);
      assert(20 < -20, false);
      assert(4 < 3, false);
      assert(0 < -1, false);

      assert("test" < "test", false);
      assert("whatsup" < "whatsu", false);
      assert("test" < 2, false);
      assert("test" < "tes", false);
      assert(2 < "asdadasd", false);
      assert("" < "", false);
      assert(false < true, false);
      assert(25000 < false, false);
      assert(000.222 < "000.222", false);
      assert(null < "lol", false);
    });

    it("compares using >=", func(assert) {
      assert(5 >= 2, true);
      assert(10 >= 10, true);
      assert(20 >= 20, true);
      assert(4 >= 3, true);
      assert(0 >= -1, true);

      assert("test" >= "test", true);
      assert("whaaatsup" >= "whatsup", true);
      assert("lol" >= "lol", true);
      assert("abc" >= "def", true);
      assert("small" >= "reaaalllybiiig", false);
    });

    it("compares using <=", func(assert) {
      assert(2 <= 5, true);
      assert(10 <= 10, true);
      assert(20 <= -20, false);
      assert(4 <= 3, false);
      assert(200 <= 200, true);

      assert("test" <= "test", true);
      assert("whaaatsup" <= "whatsup", false);
      assert("lol" <= "lol", true);
      assert("abc" <= "def", true);
      assert("small" <= "reaaalllybiiig", true);
    });

    it("not operator inverts a value", func(assert) {
      assert(!false, true);
      assert(!true, false);
      assert(!0, true);
      assert(!25, false);
      assert(!"test", false);
    });

  });

  describe("Arrays", func(it) {

    it("does member expressions", func(assert) {
      let nums = [1, 2, 3, 4];

      assert(nums[0], 1);
      assert(nums[3], 4);
      assert(nums[10], null);
      assert(nums[-10], null);
    });

    it("does multilevel member expressions", func(assert) {
      let nums = [[1, 2], [3, 4, "test"], [5, 6]];

      assert(nums[0][1], 2);
      assert(nums[2][0], 5);
      assert(nums[1][2], "test");
      assert(nums[1][-2], null);
    });

    it("write to an index", func(assert) {
      let nums = [1, 2, 3, 4];

      nums[0] = 2;
      nums[1] = 3;
      nums[2] = 4;

      assert(nums[0], 2);
      assert(nums[1], 3);
      assert(nums[2], 4);
      assert(nums[3], 4);
    });

    it("writes to a nested index", func(assert) {
      let nums = [1, 2, [3, 4]];

      nums[0] = 2;
      nums[1] = 3;
      nums[2][0] = 4;
      nums[2][1] = 5;

      assert(nums[0], 2);
      assert(nums[1], 3);
      assert(nums[2][0], 4);
      assert(nums[2][1], 5);
    });

    it("gives back the length of an array", func(assert) {
      assert(length([]), 0);
      assert(length([1, 2]), 2);
      assert(length([1, 2, [3, 4]]), 3);
      assert(length([1, 2, 3, [4, 5]][3]), 2);
      assert(length(["test"]), 1);
    });

    it("creates a new array using array_of_size", func(assert) {
      let new_array = array_of_size(100, "whaaaaaaaaaaaaaaaaaat");
      assert(length(new_array), 100);
    });

    it("appends to an array", func(assert) {
      let nums = [1, 2];
      nums = append(nums, 3);
      nums = append(nums, 4);
      nums = append(nums, 5);
      nums = append(nums, 6);

      assert(length(nums), 6);
      assert(nums[0], 1);
      assert(nums[1], 2);
      assert(nums[2], 3);
      assert(nums[3], 4);
      assert(nums[4], 5);
      assert(nums[5], 6);
    });

  });

  describe("Numerics", func(it) {

    it("implicitly casts integers to floats", func(assert) {
      assert(2 == 2.0, true);
      assert(2000.0000 == 2000, true);
      assert(-289 == -289.0, true);
      assert(0 == 0.0, true);
      assert(0000000000.000000000 == 0, true);
    });

  });

  describe("Strings", func(it) {

    it("returns the length of a string", func(assert) {
      assert(length("hello world"), 11);
      assert(length("hello"), 5);
      assert(length("ääöü"), 4);
      assert(length(""), 0);
    });

    it("concatenates strings", func(assert) {
      assert("hello" + "world", "helloworld");
      assert("hello" + " wonderful " + "world", "hello wonderful world");
      assert("öö" + "üä", "ööüä");
      assert("" + "", "");
    });

    it("concatenates strings and numerics", func(assert) {
      assert("test" + 16, "test16");
      assert("test" + 16.263723762, "test16.263723762");
      assert("test" + 0.001, "test0.001");
      assert("test" + 2.5, "test2.5");
      assert("test" + 2.0, "test2");

      assert(2 + "test", "2test");
      assert(2.5 + "test", "2.5test");
      assert(0.010 + "test", "0.01test");
      assert(28.2 + "test", "28.2test");
      assert(50 + "test" + 25, "50test25");
    });

    it("multiplies strings", func(assert) {
      assert("test" * 3, "testtesttest");
      assert(" " * 3, "   ");
      assert("a" * 10, "aaaaaaaaaa");
      assert("a" * 1.5, "a");
      assert("a" * 1.999, "a");
    });

  });

});
